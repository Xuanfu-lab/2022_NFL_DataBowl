---
title: "Untitled"
output: html_document
---
Tackle Breaking 


```{r}
library(stringr)
library('ggplot2')
library('gganimate')
library('cowplot')
library('png')
library('gifski')
library(dplyr)
library('tidyverse') 
library('lubridate') 
library('beeswarm')  
library('gganimate') 
library('ggridges')  
library('tidyr')
```

```{r}
players=read.csv('players.csv')
plays=read.csv('plays.csv')
PFF_2018=read.csv('PFFScoutingData.csv')
t_2018=read.csv('tracking2018.csv')
games_2018=read.csv('games.csv')
```

selecting punt plays only and give each play an unique id "playcombination"
```{r}
plays_punt=plays[plays$specialTeamsPlayType=='Punt'|plays$specialTeamsPlayType=='Kickoff', ]
plays_punt_2018=subset(plays_punt, floor(plays_punt$gameId/1000000)==2018)
plays_punt_2018$playcombination=paste(plays_punt_2018$playId, plays_punt_2018$gameId, sep='')
t_2018$playcombination=paste(t_2018$playId, t_2018$gameId, sep='')
t_2018_punt=subset(t_2018, t_2018$playcombination%in%plays_punt_2018$playcombination)
```

only cares about punt plays after received (ignore fair catch & out of bound)
```{r}
plays_punt_returned_2018=plays_punt_2018[plays_punt_2018$specialTeamsResult=="Return", ]
t_2018_punt=subset(t_2018_punt, t_2018_punt$playcombination%in%plays_punt_returned_2018$playcombination)
t_2018_punt$row_number=c(1:nrow(t_2018_punt))
```

data分段：

KICKOFF DATA
0. start - "kickoff"-1 (只对assignment有用，暂时可以忽略)
1. "kickoff" - "kick_received"-1 (球在空中)
2. "kick_received" - end （球落地后）

PUNT DATA
0. start - "ball-snap"-1 (只对assignment有用，暂时可以忽略)
1. "ball-snap" - "punt"-1 (球离开第一个人的手，到punter踢到球)
2. "punt" - "punt_received"-1 （球在空中）
3. "punt_received" - end （球落地后）


```{r, eval = false}
# SUPER SLOW. RUN WITH CAUTION.
t_2018_punt$received_label=0
received_punt=subset(t_2018_punt, t_2018_punt$event=='punt_received' |t_2018_punt$frameId==1)
list_interval=list()
for (a in (1:37305)){
  beginning=received_punt[a, ]$row_number
  end=received_punt[a+1, ]$row_number-1
  interval=c(beginning:end)
  if(a==1){
    list_interval[[a]]=interval
  }
  else{
    list_interval[[length(list_interval)+1]]=interval
  }
  }

for (a in 1:length(list_interval)){
  if (a%%2==1){
    t_2018_punt[list_interval[[a]], ]$received_label=0
  }
  else{
    t_2018_punt[list_interval[[a]], ]$received_label=1
  }
}

t_2018_punt_received=t_2018_punt[t_2018_punt$received_label==1, ]
```

identifying tacklers
要素：与returner之间没有其他队员阻挡
且离returner距离不超过1码
```{r}
#subsetting retuners
t_2018returners=plays_punt_2018[!is.na(plays_punt_2018$returnerId), ]
t_2018returned=t_2018returners[t_2018returners$specialTeamsResult=='Return', ]
t_2018returnersid=unique(t_2018returned$returnerId)
t_2018returnersid=gsub(";.*$","",t_2018returnersid) #Only select punt plays that are returned"
players_2018returners=subset(players, players$nflId%in%t_2018returnersid, )
```

```{r}
#returners label
plays_punt_returned_2018=plays_punt_2018[plays_punt_2018$specialTeamsResult=='Return', ]
t_2018_punt_received$returner_id=0
playcombination_1=unique(t_2018_punt_received$playcombination)

for(a in 1:length(playcombination_1)){
  returner_id_1=plays_punt_returned_2018[plays_punt_returned_2018$playcombination==playcombination_1[a], ]$returnerId
  t_2018_punt_received[t_2018_punt_received$playcombination==playcombination_1[a], ]$returner_id=returner_id_1
} 
```

```{r}
t_2018PR=subset(t_2018_punt_received, t_2018_punt_received$nflId==t_2018_punt_received$returner_id)
t_2018PR$returner_id=gsub(";.*$","",t_2018PR$returner_id)
t_2018_punt_received$returner_id=gsub(";.*$","",t_2018_punt_received$returner_id)
```

```{r eval=false}
#runtime ~2h

#selecting other players
t_2018_other_players=subset(t_2018_punt_received, !(t_2018_punt_received$nflId%in%t_2018PR$nflId))
#identifying tacklers for each frame of returners
#tacklers condition: within one yard of the returner, closer than any teammates
#the below code is to add returner's x and y coordinates for distance calculations for all players
t_2018_other_players$returner_x_coord=NA
t_2018_other_players$returner_y_coord=NA
playcombination_1=unique(t_2018_punt_received$playcombination)

for (a in 1:length(playcombination_1)){
  the_combi=playcombination_1[a]
  the_play=t_2018_punt_received[t_2018_punt_received$playcombination==the_combi, ]
  the_frame=unique(the_play$frameId)
  for (b in 1:length(the_frame)){
    the_frame_new=the_frame[b]
    the_data=t_2018_punt_received[t_2018_punt_received$playcombination==the_combi & t_2018_punt_received$frameId==the_frame_new, ]
    the_returner=subset(the_data, the_data$nflId==t_2018PR[t_2018PR$playcombination==the_combi, ]$returner_id[1])
    if(nrow(the_returner)==0){
      next
    }
    else
    {
    returner_x_coord_a=the_returner$x
    returner_y_coord_a=the_returner$y
    t_2018_other_players[t_2018_other_players$playcombination==the_combi & t_2018_other_players$frameId==the_frame_new, ]$returner_x_coord=returner_x_coord_a
    t_2018_other_players[t_2018_other_players$playcombination==the_combi & t_2018_other_players$frameId==the_frame_new, ]$returner_y_coord=returner_y_coord_a
    }
  }
}
```

Down to one yard
```{r}
t_2018_other_players$x_distance=t_2018_other_players$x-t_2018_other_players$returner_x_coord
t_2018_other_players$y_distance=t_2018_other_players$y-t_2018_other_players$returner_y_coord
t_2018_other_players$distance=sqrt(t_2018_other_players$x_distance*t_2018_other_players$x_distance+t_2018_other_players$y_distance*t_2018_other_players$y_distance)

t_2018_other_players1=t_2018_other_players[!is.na(t_2018_other_players$returner_x_coord), ]

#remove "football" data because it has N/A
tackle_frame_2018=subset(t_2018_other_players1, t_2018_other_players$distance<=1)
tackle_frame_2018=subset(tackle_frame_2018, tackle_frame_2018$team!='football')
```

classify teammates and opponents
```{r}
tackle_frame_2018$returner_team=NA
tackle_frame_2018$returner_teammates=NA
playcombination_2=unique(tackle_frame_2018$playcombination)

for (a in 1:length(playcombination_2)){
  the_combi=playcombination_2[a]
  the_play=tackle_frame_2018[tackle_frame_2018$playcombination==the_combi, ]
  the_returner_team=t_2018PR[t_2018PR$playcombination==the_combi, ]$team[1]
  tackle_frame_2018[tackle_frame_2018$playcombination==the_combi, ]$returner_team=the_returner_team
}

tackle_frame_2018$returner_teammates=(tackle_frame_2018$team==tackle_frame_2018$returner_team)
```

```{r}
# write.csv(tackle_frame_2018, file='other_players.csv')
# write.csv(t_2018PR, file='returner.csv')
```

create a rectangle with width=tracking player's position at center, length=0.5, 0.25 extended each side of player's orientation(o), length being the distance between the potential tackler and the returner

first add returner's orientation to the frame
```{r}
playcombination_3=unique((tackle_frame_2018$playcombination))
tackle_frame_2018$returner_o=NA
for (a in 1:length(playcombination_3)){
  the_combi=playcombination_3[a]
  the_play=tackle_frame_2018[tackle_frame_2018$playcombination==the_combi, ]
  the_frame=unique(the_play$frameId)
  for(b in 1:length(the_frame)){
    ro=t_2018PR[t_2018PR$playcombination==the_combi&t_2018PR$frameId==the_frame[b], ]$o
    tackle_frame_2018[tackle_frame_2018$playcombination==the_combi&tackle_frame_2018$frameId==the_frame[b],  ]$returner_o=ro
  }
}
```

```{r}
playcombination_3=unique((tackle_frame_2018$playcombination))
tackle_frame_2018$returner_s=NA
for (a in 1:length(playcombination_3)){
  the_combi=playcombination_3[a]
  the_play=tackle_frame_2018[tackle_frame_2018$playcombination==the_combi, ]
  the_frame=unique(the_play$frameId)
  for(b in 1:length(the_frame)){
    rs=t_2018PR[t_2018PR$playcombination==the_combi&t_2018PR$frameId==the_frame[b], ]$s
    tackle_frame_2018[tackle_frame_2018$playcombination==the_combi&tackle_frame_2018$frameId==the_frame[b],  ]$returner_s=rs
  }
}
```

create the coordination of the rectangle
```{r}
half_length=0.25
tackle_frame_2018$x1=NA
tackle_frame_2018$y1=NA
tackle_frame_2018$x2=NA
tackle_frame_2018$y2=NA
tackle_frame_2018$x3=NA
tackle_frame_2018$y3=NA
tackle_frame_2018$x4=NA
tackle_frame_2018$y4=NA
for (a in 1:nrow(tackle_frame_2018)){
  tackle_frame_2018[a, ]$x1=tackle_frame_2018[a, ]$x+0.25*sin(tackle_frame_2018[a, ]$o*pi/180)
  tackle_frame_2018[a, ]$y1=tackle_frame_2018[a, ]$y+0.25*cos(tackle_frame_2018[a, ]$o*pi/180)
  tackle_frame_2018[a, ]$x2=tackle_frame_2018[a, ]$x-0.25*sin(tackle_frame_2018[a, ]$o*pi/180)
  tackle_frame_2018[a, ]$y2=tackle_frame_2018[a, ]$y-0.25*cos(tackle_frame_2018[a, ]$o*pi/180)
  tackle_frame_2018[a, ]$x3=tackle_frame_2018[a, ]$returner_x_coord+0.25*sin(tackle_frame_2018[a, ]$returner_o*pi/180)
  tackle_frame_2018[a, ]$y3=tackle_frame_2018[a, ]$returner_y_coord+0.25*cos(tackle_frame_2018[a, ]$returner_o*pi/180)
  tackle_frame_2018[a, ]$x4=tackle_frame_2018[a, ]$returner_x_coord-0.25*sin(tackle_frame_2018[a, ]$returner_o*pi/180)
  tackle_frame_2018[a, ]$y4=tackle_frame_2018[a, ]$returner_y_coord-0.25*cos(tackle_frame_2018[a, ]$returner_o*pi/180)
}
```

determine if points are inside of the quadrilateral
```{r}
the_potential_tackler=tackle_frame_2018[tackle_frame_2018$team!=tackle_frame_2018$returner_team, ]
the_potential_blocker=tackle_frame_2018[tackle_frame_2018$team==tackle_frame_2018$returner_team, ]
```

```{r}
#run time ~ 20min

library(ptinpoly) #用于判断点是不是在四边形内

the_potential_tackler$is_tackler=NA
the_potential_blocker$in_the_area=NA

for(a in 1:nrow(the_potential_tackler)){
  play_combi=the_potential_tackler[a, ]$playcombination
  the_frame=the_potential_tackler[a, ]$frameId
  the_blocker=the_potential_blocker[the_potential_blocker$playcombination==play_combi&the_potential_blocker$frameId==the_frame, ]
  if(dim(the_blocker)[1]==0){
    the_potential_tackler[a, ]$is_tackler=1
  }
  else{
    for(b in 1:nrow(the_potential_blocker[the_potential_blocker$playcombination==play_combi&the_potential_blocker$frameId==the_frame, ])){
      x_blocker=the_potential_blocker[the_potential_blocker$playcombination==play_combi&the_potential_blocker$frameId==the_frame, ][b, ]$x
      y_blocker=the_potential_blocker[the_potential_blocker$playcombination==play_combi&the_potential_blocker$frameId==the_frame, ][b, ]$y
      #determine if(x,y) is in the quadrilateral
      quad=rbind(
        c(the_potential_tackler[a, ]$x1, the_potential_tackler[a, ]$y1),
        c(the_potential_tackler[a, ]$x2, the_potential_tackler[a, ]$y2),
        c(the_potential_tackler[a, ]$x3, the_potential_tackler[a, ]$y3),
        c(the_potential_tackler[a, ]$x4, the_potential_tackler[a, ]$y4)
      )
      point=rbind(c(x_blocker, y_blocker))
      result=pip2d(quad, point)
      if(result==1){
        the_potential_blocker[the_potential_blocker$playcombination==play_combi&the_potential_blocker$frameId==the_frame, ][b, ]$in_the_area=1
      }
      else{
        the_potential_blocker[the_potential_blocker$playcombination==play_combi&the_potential_blocker$frameId==the_frame, ][b, ]$in_the_area=0
      }
    }
  }
}

for(a in 1:nrow(the_potential_blocker)){
  if(is.na(the_potential_blocker[a, ]$in_the_area)){
    the_potential_blocker[a, ]$in_the_area=0
  }
}

for(a in 1:nrow(the_potential_tackler)){
  play_combi=the_potential_tackler[a, ]$playcombination
  the_frame=the_potential_tackler[a, ]$frameId
  the_blocker=the_potential_blocker[the_potential_blocker$playcombination==play_combi&the_potential_blocker$frameId==the_frame, ]
  g=dim(the_blocker)[1]
  if(g>0){
    check=any(the_blocker$in_the_area==1)
    }
  else{
    check=FALSE
  }
  if(check==TRUE){
    the_potential_tackler[a, ]$is_tackler=0
  }
  if(check==FALSE){
    the_potential_tackler[a, ]$is_tackler=1
  }
}
```

```{r}
# 不管tackler靠近之前的frame
the_potential_tackler_2018=the_potential_tackler[the_potential_tackler$is_tackler==1, ]
t_2018PR$has_tackler=0
t_2018PR$frameplaycombi=paste(t_2018PR$frameId, t_2018PR$playcombination, sep='')
the_potential_tackler_2018$frameplaycombi=paste(the_potential_tackler_2018$frameId, the_potential_tackler_2018$playcombination, sep='')

for(a in 1:nrow(t_2018PR)){
  if(t_2018PR[a, ]$frameplaycombi%in%the_potential_tackler_2018$frameplaycombi){
    t_2018PR[a, ]$has_tackler=1
  }
}
```

```{r}
t_2018PR=t_2018PR[t_2018PR$has_tackler==1, ]
```

```{r}
# write.csv(the_potential_tackler_2018, file='tacklers_2018.csv')
# write.csv(t_2018PR, file='returner_2018.csv')
```